{"remainingRequest":"/Users/kiyoungtack/Desktop/boiler/node_modules/babel-loader/lib/index.js??ruleSet[1].rules[0].use[1]!/Users/kiyoungtack/Desktop/boiler/src/controllers/userController.ts","dependencies":[{"path":"/Users/kiyoungtack/Desktop/boiler/src/controllers/userController.ts","mtime":1611314830516},{"path":"/Users/kiyoungtack/Desktop/boiler/.babelrc","mtime":1610697389559},{"path":"/Users/kiyoungtack/Desktop/boiler/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/kiyoungtack/Desktop/boiler/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IGRiIGZyb20gJ2RiJzsKCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpOwoKaW1wb3J0IHsgSm9pIH0gZnJvbSAna29hLWpvaS1yb3V0ZXInOwppbXBvcnQgZ2VuZXJhdGVUb2tlbiBmcm9tICd1dGlscy9qd3QnOwppbXBvcnQgdXBsb2FkIGZyb20gJy4uL3V0aWxzL3MzJzsKaW1wb3J0IGZzIGZyb20gJ2ZzJzsKCmNvbnN0IGhhc2ggPSBfcGFzc3dvcmQgPT4gewogIHJldHVybiBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2JywgcHJvY2Vzcy5lbnYuU0VDUkVUX0tFWSkudXBkYXRlKF9wYXNzd29yZCkuZGlnZXN0KCdoZXgnKTsKfTsKCmNvbnN0IGNyZWF0ZSA9IGFzeW5jIGN0eCA9PiB7CiAgY29uc3QgewogICAgZW1haWwsCiAgICBwYXNzd29yZCwKICAgIG5hbWUsCiAgICBjZWxsCiAgfSA9IGN0eC5yZXF1ZXN0LmJvZHk7CiAgdmFyIHBhdHRlcm4gPSAvXFMrQFxTK1wuXFMrLzsKICBjb25zdCBlbWFpbFZhbCA9IHBhdHRlcm4udGVzdChlbWFpbCk7CgogIGlmIChlbWFpbFZhbCA9PT0gZmFsc2UpIHsKICAgIGN0eC5zdGF0dXMgPSA0MDA7CiAgICByZXR1cm47CiAgfQoKICBjb25zdCBoYXNoZWQgPSBoYXNoKHBhc3N3b3JkKTsKICBjb25zdCBtYW4gPSBhd2FpdCBkYi51c2Vycy5maW5kT25lKHsKICAgIGVtYWlsCiAgfSk7CgogIGlmIChtYW4pIHsKICAgIGN0eC5zdGF0dXMgPSA0MDM7CiAgfSBlbHNlIHsKICAgIGF3YWl0IGRiLnVzZXJzLmNyZWF0ZSh7CiAgICAgIGVtYWlsLAogICAgICBwYXNzd29yZDogaGFzaGVkLAogICAgICBuYW1lLAogICAgICBjZWxsCiAgICB9KTsKICAgIGN0eC5zdGF0dXMgPSAyMDA7CiAgICBjb25zdCB1c2VyMSA9IGF3YWl0IGRiLnVzZXJzLmZpbmRPbmUoewogICAgICBlbWFpbAogICAgfSk7CiAgICBjdHguYm9keSA9IHVzZXIxOwogIH0KfTsKCmNvbnN0IGxvZ2luID0gYXN5bmMgY3R4ID0+IHsKICBjb25zdCB7CiAgICBlbWFpbCwKICAgIHBhc3N3b3JkCiAgfSA9IGN0eC5yZXF1ZXN0LmJvZHk7CiAgY29uc3QgaGFzaGVkID0gaGFzaChwYXNzd29yZCk7CiAgY29uc3Qgc2NoZW1hID0gSm9pLm9iamVjdCgpLmtleXMoewogICAgZW1haWw6IEpvaS5zdHJpbmcoKS5lbWFpbCgpLnJlcXVpcmVkKCksCiAgICBwYXNzd29yZDogSm9pLnN0cmluZygpLnJlcXVpcmVkKCkKICB9KTsKICBzY2hlbWEudmFsaWRhdGVBc3luYyh7CiAgICBlbWFpbCwKICAgIHBhc3N3b3JkCiAgfSkudGhlbihyZXN1bHQgPT4gewogICAgY3R4LnJlcXVlc3QuYm9keSA9IHJlc3VsdDsKICB9KS5jYXRjaChlcnIgPT4gewogICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gdmFsaWRhdGUgaW5wdXQgJyArIGVyci5kZXRhaWxzWzBdLm1lc3NhZ2UpOwogIH0pOwogIGxldCB1c2VyID0gbnVsbDsKCiAgdHJ5IHsKICAgIHVzZXIgPSBhd2FpdCBkYi51c2Vycy5maW5kT25lKHsKICAgICAgZW1haWwKICAgIH0pOwogIH0gY2F0Y2ggKGUpIHsKICAgIGN0eC50aHJvdyg1MDAsIGUpOwogIH0KCiAgaWYgKCF1c2VyIHx8IHVzZXIucGFzc3dvcmQgIT09IGAke2hhc2hlZH1gKSB7CiAgICBjdHguc3RhdHVzID0gNDAzOyAvLyBGb3JiaWRkZW4KCiAgICByZXR1cm47CiAgfQoKICBjdHguc3RhdHVzID0gMjAwOwogIGNvbnN0IHRva2VuID0gYXdhaXQgZ2VuZXJhdGVUb2tlbih7CiAgICBfaWQ6IHVzZXIuaWQsCiAgICBlbWFpbDogdXNlci5lbWFpbAogIH0pOwogIGN0eC5ib2R5ID0gdG9rZW47CiAgcmV0dXJuOwp9OwoKY29uc3QgdXBkYXRlID0gYXN5bmMgY3R4ID0+IHsKICBjb25zdCB7CiAgICBlbWFpbCwKICAgIHBhc3N3b3JkLAogICAgbmFtZSwKICAgIGNlbGwKICB9ID0gY3R4LnJlcXVlc3QuYm9keTsKICBjb25zdCBoYXNoZWQgPSBoYXNoKHBhc3N3b3JkKTsKICBhd2FpdCBkYi51c2Vycy5maW5kT25lQW5kVXBkYXRlKHsKICAgIGVtYWlsCiAgfSwgewogICAgcGFzc3dvcmQ6IGhhc2hlZCwKICAgIG5hbWUsCiAgICBjZWxsCiAgfSk7CiAgY3R4LnN0YXR1cyA9IDIwMDsKfTsKCmNvbnN0IGRlbGV0ZW9uZSA9IGFzeW5jIGN0eCA9PiB7CiAgY29uc3QgewogICAgZW1haWwKICB9ID0gY3R4LnJlcXVlc3QuYm9keTsKICBhd2FpdCBsb2dpbihjdHgpOwoKICBpZiAoY3R4LnN0YXR1cyA9PT0gMjAwKSB7CiAgICBkYi51c2Vycy5kZWxldGVPbmUoewogICAgICBlbWFpbAogICAgfSk7CiAgICBjb25zb2xlLmxvZyhlbWFpbCwgJyB1c2VyIGRlbGV0ZWQnKTsKICB9IGVsc2UgewogICAgY29uc29sZS5sb2coJ3VzZXIgYWxyZWFkeSBnb25lJyk7CiAgfQp9OwoKY29uc3QgZmluZG9uZSA9IGFzeW5jIGN0eCA9PiB7CiAgY29uc3QgewogICAgaWQKICB9ID0gY3R4LnBhcmFtczsKICBjb25zdCB1c2VyID0gYXdhaXQgZGIudXNlcnMuZmluZE9uZSh7CiAgICBfaWQ6IGlkCiAgfSk7CiAgY3R4LnN0YXR1cyA9IDIwMDsKICBjdHguYm9keSA9IHVzZXI7Cn07Cgpjb25zdCB1cGxvYWRQcm9maWxlID0gYXN5bmMgY3R4ID0+IHsKICBjb25zdCB1c2VyID0gYXdhaXQgZGIudXNlcnMuZmluZE9uZSh7CiAgICBfaWQ6IGN0eC5zdGF0ZS51c2VyLl9pZAogIH0pOwogIGNvbnN0IHsKICAgIHBhdGgKICB9ID0gY3R4LnJlcXVlc3QuZmlsZXMucHJvZmlsZXBpYzsKICBjb25zdCBib2R5ID0gZnMuY3JlYXRlUmVhZFN0cmVhbShwYXRoKTsKICBjb25zdCBwYXJhbSA9IHsKICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYucGp0X25hbWUsCiAgICBLZXk6IGBwcm9maWxlaW1hZ2UvJHt1c2VyLl9pZH1gLAogICAgQUNMOiAncHVibGljLXJlYWQnLAogICAgQm9keTogYm9keSwKICAgIENvbnRlbnRUeXBlOiAnaW1hZ2UvcG5nJwogIH07CiAgY29uc3QgdXAgPSBhd2FpdCB1cGxvYWQocGFyYW0pOwogIHVzZXIucHJvZmlsZXBpYyA9IHVwLkxvY2F0aW9uOwogIHVzZXIuc2F2ZSgpOwogIGN0eC5zdGF0dXMgPSAyMDA7Cn07Cgpjb25zdCBsb2dvdXQgPSBjdHggPT4gewogIGN0eC5zdGF0dXMgPSAyMDA7Cn07CgpleHBvcnQgZGVmYXVsdCB7CiAgY3JlYXRlLAogIGxvZ2luLAogIHVwZGF0ZSwKICBkZWxldGVvbmUsCiAgZmluZG9uZSwKICBsb2dvdXQsCiAgdXBsb2FkUHJvZmlsZQp9Ow=="},{"version":3,"sources":["/Users/kiyoungtack/Desktop/boiler/src/controllers/userController.ts"],"names":["db","crypto","require","Joi","generateToken","upload","fs","hash","_password","createHash","process","env","SECRET_KEY","update","digest","create","ctx","email","password","name","cell","request","body","pattern","emailVal","test","status","hashed","man","users","findOne","user1","login","schema","object","keys","string","required","validateAsync","then","result","catch","err","Error","details","message","user","e","throw","token","_id","id","findOneAndUpdate","deleteone","deleteOne","console","log","findone","params","uploadProfile","state","path","files","profilepic","createReadStream","param","Bucket","pjt_name","Key","ACL","Body","ContentType","up","Location","save","logout"],"mappings":"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","sourcesContent":["import db from 'db';\nimport { Controller } from './types';\nconst crypto = require('crypto');\nimport { Joi } from 'koa-joi-router';\nimport generateToken from 'utils/jwt';\nimport upload from '../utils/s3';\nimport fs from 'fs';\n\nconst hash: Controller = (_password: any) => {\n  return crypto\n    .createHash('sha256', process.env.SECRET_KEY)\n    .update(_password)\n    .digest('hex');\n};\n\nconst create: Controller = async (ctx) => {\n  const { email, password, name, cell } = ctx.request.body;\n  var pattern = /\\S+@\\S+\\.\\S+/;\n  const emailVal = pattern.test(email);\n  if (emailVal === false) {\n    ctx.status = 400;\n    return;\n  }\n  const hashed = hash(password);\n  const man = await db.users.findOne({ email });\n  if (man) {\n    ctx.status = 403;\n  } else {\n    await db.users.create({\n      email,\n      password: hashed,\n      name,\n      cell,\n    });\n    ctx.status = 200;\n    const user1 = await db.users.findOne({\n      email,\n    });\n    ctx.body = user1;\n  }\n};\n\nconst login: Controller = async (ctx) => {\n  const { email, password } = ctx.request.body;\n  const hashed = hash(password);\n  const schema = Joi.object().keys({\n    email: Joi.string().email().required(),\n    password: Joi.string().required(),\n  });\n  schema\n    .validateAsync({ email, password })\n    .then((result) => {\n      ctx.request.body = result;\n    })\n    .catch((err) => {\n      throw new Error('Failed to validate input ' + err.details[0].message);\n    });\n  let user: any = null;\n  try {\n    user = await db.users.findOne({ email });\n  } catch (e) {\n    ctx.throw(500, e);\n  }\n  if (!user || user.password !== `${hashed}`) {\n    ctx.status = 403; // Forbidden\n    return;\n  }\n  ctx.status = 200;\n  const token = await generateToken({ _id: user.id, email: user.email });\n  ctx.body = token;\n  return;\n};\n\nconst update: Controller = async (ctx) => {\n  const { email, password, name, cell } = ctx.request.body;\n  const hashed = hash(password);\n  await db.users.findOneAndUpdate({ email }, { password: hashed, name, cell });\n  ctx.status = 200;\n};\n\nconst deleteone: Controller = async (ctx) => {\n  const { email } = ctx.request.body;\n  await login(ctx);\n  if (ctx.status === 200) {\n    db.users.deleteOne({ email });\n    console.log(email, ' user deleted');\n  } else {\n    console.log('user already gone');\n  }\n};\n\nconst findone: Controller = async (ctx) => {\n  const { id } = ctx.params;\n  const user = await db.users.findOne({ _id: id });\n  ctx.status = 200;\n  ctx.body = user;\n};\n\nconst uploadProfile: Controller = async (ctx) => {\n  const user: any = await db.users.findOne({ _id: ctx.state.user._id });\n  const { path } = ctx.request.files.profilepic;\n  const body = fs.createReadStream(path);\n  const param = {\n    Bucket: process.env.pjt_name,\n    Key: `profileimage/${user._id}`,\n    ACL: 'public-read',\n    Body: body,\n    ContentType: 'image/png',\n  };\n  const up = await upload(param);\n  (user as any).profilepic = up.Location;\n  user.save();\n  ctx.status = 200;\n};\n\nconst logout: Controller = (ctx) => {\n  ctx.status = 200;\n};\n\nexport default {\n  create,\n  login,\n  update,\n  deleteone,\n  findone,\n  logout,\n  uploadProfile,\n};\n"]}]}