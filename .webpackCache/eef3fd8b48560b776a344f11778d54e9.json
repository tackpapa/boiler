{"remainingRequest":"/Users/kiyoungtack/Desktop/boiler/node_modules/babel-loader/lib/index.js??ruleSet[1].rules[0].use[1]!/Users/kiyoungtack/Desktop/boiler/src/utils/jwt.ts","dependencies":[{"path":"/Users/kiyoungtack/Desktop/boiler/src/utils/jwt.ts","mtime":1611471640288},{"path":"/Users/kiyoungtack/Desktop/boiler/.babelrc","mtime":1610697389559},{"path":"/Users/kiyoungtack/Desktop/boiler/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/kiyoungtack/Desktop/boiler/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IGRiIGZyb20gJ2RiJzsKaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nOwpjb25zdCBvcHRpb24gPSB7CiAgZXhwaXJlc0luOiAnN2QnCn07Cgpjb25zdCBnZW5lcmF0ZVRva2VuID0gcGF5bG9hZCA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgand0LnNpZ24ocGF5bG9hZCwgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCwgb3B0aW9uLCAoZXJyb3IsIHRva2VuKSA9PiB7CiAgICBpZiAoZXJyb3IgfHwgIXRva2VuKSB7CiAgICAgIHJlamVjdChlcnJvcik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICByZXNvbHZlKHRva2VuKTsKICB9KTsKfSk7CgpleHBvcnQgY29uc3QgZGVjb2RlSldUID0gdG9rZW4gPT4gand0LnZlcmlmeSh0b2tlbiwgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCk7CmV4cG9ydCBjb25zdCByZXF1aXJlQXV0aCA9IChjdHgsIG5leHQpID0+IHsKICBpZiAoIWN0eC5zdGF0ZS51c2VyKSB7CiAgICBjdHguYm9keSA9ICfroZzqt7jsnbjsnbQg7ZWE7JqU7ZWp64uI64ukJzsKICAgIGN0eC5zdGF0dXMgPSA0MDE7CiAgICByZXR1cm4gbnVsbDsKICB9CgogIHJldHVybiBuZXh0KCk7Cn07CmV4cG9ydCBjb25zdCBqd3RQYXJzZXIgPSBhc3luYyAoY3R4LCBuZXh0KSA9PiB7CiAgY29uc3QgdG9rZW4gPSBjdHguaGVhZGVyLmF1dGhvcml6YXRpb247CgogIGlmICh0b2tlbikgewogICAgY29uc3QgdXNlciA9IGRlY29kZUpXVCh0b2tlbi5yZXBsYWNlKC9eQmVhcmVyIC8sICcnKSk7CiAgICBjdHguc3RhdGUudXNlciA9IHVzZXI7CiAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgZGIuc2Vzc2lvbnMuZmluZE9uZSh7CiAgICAgIHVzZXJJZDogdXNlci5faWQKICAgIH0pOwoKICAgIGlmIChzZXNzaW9uKSB7CiAgICAgIGN0eC5zdGF0ZS5zb2NrZXRJZCA9IHNlc3Npb24uY29ubmVjdGlvbklkOwogICAgfQogIH0KCiAgYXdhaXQgbmV4dCgpOwp9OwpleHBvcnQgZGVmYXVsdCBnZW5lcmF0ZVRva2VuOw=="},{"version":3,"sources":["/Users/kiyoungtack/Desktop/boiler/src/utils/jwt.ts"],"names":["db","jwt","option","expiresIn","generateToken","payload","Promise","resolve","reject","sign","process","env","JWT_SECRET","error","token","decodeJWT","verify","requireAuth","ctx","next","state","user","body","status","jwtParser","header","authorization","replace","session","sessions","findOne","userId","_id","socketId","connectionId"],"mappings":"AAAA,OAAOA,EAAP,MAAe,IAAf;AAEA,OAAOC,GAAP,MAAgB,cAAhB;AAQA,MAAMC,MAAM,GAAG;AACbC,EAAAA,SAAS,EAAE;AADE,CAAf;;AAIA,MAAMC,aAAa,GAAIC,OAAD,IACpB,IAAIC,OAAJ,CAAoB,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvCP,EAAAA,GAAG,CAACQ,IAAJ,CAASJ,OAAT,EAAkBK,OAAO,CAACC,GAAR,CAAYC,UAA9B,EAA2CV,MAA3C,EAAmD,CAACW,KAAD,EAAQC,KAAR,KAAkB;AACnE,QAAID,KAAK,IAAI,CAACC,KAAd,EAAqB;AACnBN,MAAAA,MAAM,CAACK,KAAD,CAAN;AACA;AACD;;AACDN,IAAAA,OAAO,CAACO,KAAD,CAAP;AACD,GAND;AAOD,CARD,CADF;;AAWA,OAAO,MAAMC,SAAS,GAAID,KAAD,IACvBb,GAAG,CAACe,MAAJ,CAAWF,KAAX,EAAkBJ,OAAO,CAACC,GAAR,CAAYC,UAA9B,CADK;AAGP,OAAO,MAAMK,WAAW,GAAG,CAACC,GAAD,EAAeC,IAAf,KAAoC;AAC7D,MAAI,CAACD,GAAG,CAACE,KAAJ,CAAUC,IAAf,EAAqB;AACnBH,IAAAA,GAAG,CAACI,IAAJ,GAAW,YAAX;AACAJ,IAAAA,GAAG,CAACK,MAAJ,GAAa,GAAb;AACA,WAAO,IAAP;AACD;;AACD,SAAOJ,IAAI,EAAX;AACD,CAPM;AAQP,OAAO,MAAMK,SAAS,GAAG,OAAON,GAAP,EAAqBC,IAArB,KAAkD;AACzE,QAAML,KAAK,GAAGI,GAAG,CAACO,MAAJ,CAAWC,aAAzB;;AACA,MAAIZ,KAAJ,EAAW;AACT,UAAMO,IAAI,GAAGN,SAAS,CAACD,KAAK,CAACa,OAAN,CAAc,UAAd,EAA0B,EAA1B,CAAD,CAAtB;AACAT,IAAAA,GAAG,CAACE,KAAJ,CAAUC,IAAV,GAAiBA,IAAjB;AACA,UAAMO,OAAO,GAAG,MAAM5B,EAAE,CAAC6B,QAAH,CAAYC,OAAZ,CAAoB;AACxCC,MAAAA,MAAM,EAAEV,IAAI,CAACW;AAD2B,KAApB,CAAtB;;AAGA,QAAIJ,OAAJ,EAAa;AACXV,MAAAA,GAAG,CAACE,KAAJ,CAAUa,QAAV,GAAqBL,OAAO,CAACM,YAA7B;AACD;AACF;;AACD,QAAMf,IAAI,EAAV;AACD,CAbM;AAeP,eAAef,aAAf","sourcesContent":["import db from 'db';\nimport { Context } from 'koa';\nimport jwt from 'jsonwebtoken';\nimport mongoose from 'mongoose';\n\nexport interface JWT {\n  _id: mongoose.Types.ObjectId;\n  email: string;\n}\n\nconst option = {\n  expiresIn: '7d',\n};\n\nconst generateToken = (payload: JWT) =>\n  new Promise<string>((resolve, reject) => {\n    jwt.sign(payload, process.env.JWT_SECRET!, option, (error, token) => {\n      if (error || !token) {\n        reject(error);\n        return;\n      }\n      resolve(token);\n    });\n  });\n\nexport const decodeJWT = (token: string) =>\n  jwt.verify(token, process.env.JWT_SECRET!) as JWT;\n\nexport const requireAuth = (ctx: Context, next: () => void) => {\n  if (!ctx.state.user) {\n    ctx.body = '로그인이 필요합니다';\n    ctx.status = 401;\n    return null;\n  }\n  return next();\n};\nexport const jwtParser = async (ctx: Context, next: () => Promise<any>) => {\n  const token = ctx.header.authorization;\n  if (token) {\n    const user = decodeJWT(token.replace(/^Bearer /, ''));\n    ctx.state.user = user;\n    const session = await db.sessions.findOne({\n      userId: user._id,\n    });\n    if (session) {\n      ctx.state.socketId = session.connectionId;\n    }\n  }\n  await next();\n};\n\nexport default generateToken;\n"]}]}